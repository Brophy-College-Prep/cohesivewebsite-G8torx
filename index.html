<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mazda 787DB</title>

  <!-- Import map so the module script can import THREE modules -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
      "three/examples/jsm/": "https://unpkg.com/three@0.158.0/examples/jsm/"
    }
  }
  </script>

  <style>
    :root {
      --bs-blue: #0d6efd;
      --bs-indigo: #6610f2;
      --bs-purple: #6f42c1;
      --bs-pink: #d63384;
      --bs-red: #dc3545;
      --bs-orange: #bd5d38;
      --bs-yellow: #ffc107;
      --bs-green: #198754;
      --bs-teal: #20c997;
      --bs-cyan: #0dcaf0;
      --bs-white: #fff;
      --bs-gray: #6c757d;
      --bs-gray-dark: #343a40;
      --bs-gray-100: #f8f9fa;
      --bs-gray-200: #e9ecef;
      --bs-gray-300: #dee2e6;
      --bs-gray-400: #ced4da;
      --bs-gray-500: #adb5bd;
      --bs-gray-600: #6c757d;
      --bs-gray-700: #495057;
      --bs-gray-800: #343a40;
      --bs-gray-900: #212529;
      --bs-primary: #3474ff;
      --bs-secondary: #6c757d;
      --bs-success: #198754;
      --bs-info: #0dcaf0;
      --bs-warning: #ffc107;
      --bs-danger: #dc3545;
      --bs-light: #f8f9fa;
      --bs-dark: #212529;
      --bs-primary-rgb: 52, 116, 255;
      --bs-secondary-rgb: 108, 117, 125;
      --bs-success-rgb: 25, 135, 84;
      --bs-info-rgb: 13, 202, 240;
      --bs-warning-rgb: 255, 193, 7;
      --bs-danger-rgb: 220, 53, 69;
      --bs-light-rgb: 248, 249, 250;
      --bs-dark-rgb: 33, 37, 41;
      --bs-white-rgb: 255, 255, 255;
      --bs-black-rgb: 0, 0, 0;
      --bs-body-color-rgb: 33, 37, 41;
      --bs-body-bg-rgb: 255, 255, 255;
      --bs-font-sans-serif: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      --bs-font-monospace: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --bs-gradient: linear-gradient(180deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0));
      --bs-body-font-family: Muli, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --bs-body-font-size: 1rem;
      --bs-body-font-weight: 400;
      --bs-body-line-height: 1.5;
      --bs-body-color: #212529;
      --bs-body-bg: #fff;
    }

    body{
      margin:0;
      min-height:100vh;
      background:#fff;
      overflow:hidden;
      position:relative;
      font-family: var(--bs-font-sans-serif);
    }

    /* FULLSCREEN 3D CANVAS */
    #stage{
      position:fixed;
      inset:0;
      z-index:1;
      pointer-events:auto;
    }

    canvas{
      width:100%;
      height:100%;
      display:block;
      background:transparent;
      touch-action:none;
      cursor:grab; /* interactive */
    }
    canvas:active{ cursor:grabbing; }

    /* Left third text */
    .side-text-center{
      position:absolute;
      left:0;
      top:0;
      width:33.333vw;
      height:100vh;

      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;

      z-index:10;
      pointer-events:none;
      gap: 16px;
    }

    /* Right third text */
    .side-text-center-right{
      position:absolute;
      left:66.666vw;
      top:0;
      width:33.333vw;
      height:100vh;

      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;

      z-index:10;
      pointer-events:none;
      gap: 16px;
    }

    h1, h2 { margin: 1; }

    h1{
      font-size: 60px;
      font-family: 'Montserrat', sans-serif;
      line-height: 0.95;
    }

    h2{
      font-size: 40px;
      font-family: 'Montserrat', sans-serif;
    }

    p{
      font-size: 25px;
      font-family: 'Montserrat', sans-serif;
      color: rgb(255, 255, 255);
    }

    /* Your 3D rotating link button */
    a{
      position: relative;
      width: 150px;
      height: 50px;
      transition: 4s;
      transform-style: preserve-3d;
      transform: perspective(1000px) rotateX(0deg);
    }
    a:hover{
      transform: perspective(1000px) rotateX(360deg);
    }
    a span{
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #000;
      background: rgba(255, 255, 255, 0.9);
      font-family: sans-serif;
      text-transform: uppercase;
      font-size: 22px;
      letter-spacing: 2px;
      transition: 0.5s;
      border: 2px solid #000;
      box-sizing: border-box;
      box-shadow: inset 0 20px 50px rgba(0, 0, 0, 0.2);
    }
    a:hover span{
      color: #fff;
      background: rgba(3, 169, 244, 0.8);
    }
    a span:nth-child(1){ transform: rotateX(360deg) translateZ(25px); }
    a span:nth-child(2){ transform: rotateX(270deg) translateZ(25px); }
    a span:nth-child(3){ transform: rotateX(180deg) translateZ(25px); }
    a span:nth-child(4){ transform: rotateX(90deg) translateZ(25px); }

    .fade-in{
      opacity: 0;
      animation: fadeIn 1.2s ease forwards;
    }
    @keyframes fadeIn{
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Button-86 (unchanged) */
    .button-86{
      all: unset;
      width: 100px;
      height: 30px;
      font-size: 16px;
      background: transparent;
      border: none;
      position: relative;
      color: #f0f0f0;
      cursor: pointer;
      z-index: 1;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }

    .button-86::after,
    .button-86::before{
      content: '';
      position: absolute;
      bottom: 0;
      right: 0;
      z-index: -99999;
      transition: all .4s;
    }

    .button-86::before{
      transform: translate(0%, 0%);
      width: 100%;
      height: 100%;
      background: #28282d;
      border-radius: 10px;
    }

    .button-86::after{
      transform: translate(10px, 10px);
      width: 35px;
      height: 35px;
      background: #ffffff15;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border-radius: 50px;
    }

    .button-86:hover::before{
      transform: translate(5%, 20%);
      width: 110%;
      height: 110%;
    }

    .button-86:hover::after{
      border-radius: 10px;
      transform: translate(0, 0);
      width: 100%;
      height: 100%;
    }

    .button-86:active::after{
      transition: 0s;
      transform: translate(0, 5%);
    }

    /* Mobile: stack text */
    @media (max-width: 800px){
      .side-text-center{
        width:100vw;
        padding: 0 18px;
      }
      .side-text-center-right{
        left:0;
        width:100vw;
        height:auto;
        top:auto;
        bottom: 40px;
        padding: 0 18px;
      }
    }
  </style>
</head>

<body>
  <h1 class="side-text-center">Mazda<br/>787DB</h1>
  <h1 class="side-text-center-right">The<br/>Banshee</h1>

  <div id="stage"></div>

  <script type="module">
    import * as THREE from "three";
    import { GLTFLoader } from "three/examples/jsm/loaders/GLTFLoader.js";
    import { RoomEnvironment } from "three/examples/jsm/environments/RoomEnvironment.js";

    const stage = document.getElementById("stage");
    const scene = new THREE.Scene();

    const camera = new THREE.PerspectiveCamera(
      35,
      window.innerWidth / window.innerHeight,
      0.1,
      500
    );

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.55;
    stage.appendChild(renderer.domElement);

    // ===== Studio environment lighting (makes car paint/metal not black) =====
    const pmrem = new THREE.PMREMGenerator(renderer);
    const envTex = pmrem.fromScene(new RoomEnvironment(), 0.04).texture;
    scene.environment = envTex;

    // Extra lights (adds punch)
    scene.add(new THREE.AmbientLight(0xffffff, 0.35));

    const key = new THREE.DirectionalLight(0xffffff, 3.2);
    key.position.set(6, 9, 8);
    scene.add(key);

    const fill = new THREE.DirectionalLight(0xffffff, 1.6);
    fill.position.set(-8, 3, 6);
    scene.add(fill);

    const rim = new THREE.DirectionalLight(0xffffff, 2.2);
    rim.position.set(-2, 8, -10);
    scene.add(rim);

    // ===== MODEL STACK =====
    // userGroup: user temporary drag rotation
    // tiltGroup: your fixed hero tilt (always returns here)
    // spinGroup: auto spin (stops while dragging)
    const userGroup = new THREE.Group();
    const tiltGroup = new THREE.Group();
    const spinGroup = new THREE.Group();
    scene.add(userGroup);
    userGroup.add(tiltGroup);
    tiltGroup.add(spinGroup);

    // ===== YOUR FIXED ROTATION VALUES =====
    const defaultUserRot = new THREE.Euler(-1.413717, 0.221227, 0.000000);
    const defaultTilt    = new THREE.Euler(-0.785398, 0.000000, 0.314159);

    // Apply initial fixed pose
    userGroup.rotation.copy(defaultUserRot);
    tiltGroup.rotation.copy(defaultTilt);

    // Camera
    camera.position.set(0, 2.2, 12.0);
    camera.lookAt(0, 0, 0);
    camera.updateProjectionMatrix();

    // ===== Load Model =====
    const loader = new GLTFLoader();
    let model = null;

    loader.load(
      "./model.glb",
      (gltf) => {
        model = gltf.scene;
        spinGroup.add(model);

        // Texture crispness
        model.traverse((o) => {
          if (o.isMesh && o.material) {
            const mats = Array.isArray(o.material) ? o.material : [o.material];
            for (const m of mats) {
              if (m.map) {
                m.map.anisotropy = Math.min(8, renderer.capabilities.getMaxAnisotropy());
                m.map.needsUpdate = true;
              }
              m.needsUpdate = true;
            }
          }
        });

        // Center model
        const box = new THREE.Box3().setFromObject(model);
        const size = box.getSize(new THREE.Vector3());
        const center = box.getCenter(new THREE.Vector3());
        model.position.sub(center);

        // Scale
        const maxDim = Math.max(size.x, size.y, size.z);
        const desired = 6.8; // bigger/smaller
        model.scale.setScalar(desired / maxDim);

        // If your GLB is authored upside down, keep this. If it's wrong, set to 0.
        model.rotation.x = Math.PI;

        // Move up/down (THIS line moves the whole model up/down)
        // Positive = up, Negative = down
        userGroup.position.y = 0.0;

        // Re-lock pose
        userGroup.rotation.copy(defaultUserRot);
        tiltGroup.rotation.copy(defaultTilt);
      },
      undefined,
      (err) => console.error("Failed to load ./model.glb", err)
    );

    // ===== DRAG INTERACTION (stops spin while dragging, then snaps back) =====
    let isDragging = false;
    let lastX = 0;
    let lastY = 0;

    const dragStrength = 0.005;

    // Clamp pitch so it doesn't flip upside down
    const minPitch = -Math.PI * 0.95;
    const maxPitch = -Math.PI * 0.05;

    renderer.domElement.addEventListener("pointerdown", (e) => {
      isDragging = true;
      lastX = e.clientX;
      lastY = e.clientY;
      renderer.domElement.setPointerCapture(e.pointerId);
    });

    renderer.domElement.addEventListener("pointermove", (e) => {
      if (!isDragging) return;

      const dx = e.clientX - lastX;
      const dy = e.clientY - lastY;
      lastX = e.clientX;
      lastY = e.clientY;

      // Rotate the USER group while dragging
      userGroup.rotation.y += dx * dragStrength;
      userGroup.rotation.x += dy * dragStrength;

      userGroup.rotation.x = THREE.MathUtils.clamp(userGroup.rotation.x, minPitch, maxPitch);
    });

    function endDrag(e){
      isDragging = false;
      try { renderer.domElement.releasePointerCapture(e.pointerId); } catch {}
    }
    renderer.domElement.addEventListener("pointerup", endDrag);
    renderer.domElement.addEventListener("pointercancel", endDrag);
    renderer.domElement.addEventListener("pointerleave", () => { isDragging = false; });

    // ===== AUTO SPIN + SNAP BACK TO YOUR FIXED POINTS =====
    const autoSpinSpeed = 0.012; // slower/faster
    const snapStrength  = 0.10;  // faster/slower return

    function animate() {
      requestAnimationFrame(animate);

      // Always keep tilt locked
      tiltGroup.rotation.copy(defaultTilt);

      if (!isDragging) {
        // Spin only when not dragging
        spinGroup.rotation.y += autoSpinSpeed;

        // Smoothly return to EXACT fixed points after release
        userGroup.rotation.x += (defaultUserRot.x - userGroup.rotation.x) * snapStrength;
        userGroup.rotation.y += (defaultUserRot.y - userGroup.rotation.y) * snapStrength;
        userGroup.rotation.z += (defaultUserRot.z - userGroup.rotation.z) * snapStrength;
      }

      renderer.render(scene, camera);
    }
    animate();

    // Resize
    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
